<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electric Bill Calculator</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">
    <h2>‚ö° ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (AI Calculator)</h2>

    <div class="header-row">
        <div class="header-item">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</div>
        <div class="header-item">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ (kWh)</div>
    </div>

    <div id="appliance-list">
        <div class="input-group">
            <input type="text" name="name[]" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏≠‡∏£‡πå)">
            <input type="number" name="kwh[]" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢ (kWh)">
        </div>
    </div>

    <div class="btn-group">
        <button type="button" class="btn-add" onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button type="button" class="btn-calc" onclick="calculate()">üöÄ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</button>
    </div>

    <div id="loading-section">
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <div id="timer-text" class="timer-text">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 05:00 ‡∏ô‡∏≤‡∏ó‡∏µ</div>
    </div>

    <div class="result-section">
        <h3>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å AI</h3>
        <pre id="result">...</pre>
    </div>
</div>

<script>
let timerInterval;

function addRow() {
    const list = document.getElementById("appliance-list");
    const row = document.createElement("div");
    row.className = "input-group";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.name = "name[]";
    nameInput.placeholder = "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤";

    const kwhInput = document.createElement("input");
    kwhInput.type = "number";
    kwhInput.name = "kwh[]";
    kwhInput.placeholder = "kWh";

    row.appendChild(nameInput);
    row.appendChild(kwhInput);
    list.appendChild(row);
}

function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
}

async function calculate(){
    const resultBox = document.getElementById("result");
    const loadingSection = document.getElementById("loading-section");
    const progressBar = document.getElementById("progress-bar");
    const timerText = document.getElementById("timer-text");

    // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏Å‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Loading
    resultBox.textContent = "";
    loadingSection.style.display = "block";
    
    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ (300 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    let timeLeft = 300; 
    const totalTime = 300;
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏≠‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°
    progressBar.style.width = "100%";
    timerText.textContent = `AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${formatTime(timeLeft)} ‡∏ô‡∏≤‡∏ó‡∏µ`;

    // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        timeLeft--;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        timerText.textContent = `AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ${formatTime(timeLeft)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏≠‡∏î
        const percentage = (timeLeft / totalTime) * 100;
        progressBar.style.width = `${percentage}%`;

        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            loadingSection.style.display = "none";
            resultBox.textContent = "AI ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤";
        }
    }, 1000);

    // 4. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏á Backend
    const appliance = document.querySelectorAll('input[name="name[]"]');
    const kwhs  = document.querySelectorAll('input[name="kwh[]"]');
    const appliance_data = [];

    for (let i = 0; i < appliance.length; i++) {
        if(appliance[i].value || kwhs[i].value) {
            appliance_data.push({
                appliance: appliance[i].value,
                units: kwhs[i].value
            });
        }
    }

    try {
        const res = await fetch("/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(appliance_data)
        });

        const json = await res.json();

        // ** ‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ) **
        clearInterval(timerInterval); 
        loadingSection.style.display = "none"; 

        resultBox.textContent = json.ok ? json.answer : ("Error: " + json.error);

    } catch (error) {
        clearInterval(timerInterval);
        loadingSection.style.display = "none";
        resultBox.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message;
    }
}
</script>

</body>
</html>